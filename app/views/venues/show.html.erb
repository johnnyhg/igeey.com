<% @title = @venue.name %>
<% @saying = Saying.new %>
<% @photo = Photo.new %>
<% @calling = Calling.new %>
<% @topic = Topic.new %>
<% content_for :head do %>
  <%= javascript_include_tag 'calendar.js' %>
  <script type="text/javascript" src="http://ditu.google.cn/maps/api/js?sensor=false"></script>
<% end %>

<div class="box" id="venue_head">
    <%= render :partial => "/venues/venue",:object => @venue %>
    <div style="position:absolute;margin-top:76px;margin-left:3px"><%= raw(follow_to(@venue)) %></div>
  <div style="width:520px;_width:510px;;margin:10px 0 10px 80px">
    <div id="formContaier">
      <%= form_for [@venue,@saying] do |form| %>
        <div class='venue_form'>
          <h3>在<%= @venue.name%>报到：</h3>
          <%= form.hidden_field :venue_id,:value => @venue.id %>
          <%= form.text_area  :content,:style => 'height:48px',:placeholder => "今天你想和#{@venue.name}的朋友们说什么？"%>
        </div>  
        <p style="text-align:right">
          <%= form.submit '确 定',:class => "gary_button"%>
        </p>
      <% end %>
      
      <%= form_for @photo,:html => { :multipart => true } do |form| %>
        <%= form.hidden_field :venue_id,:value => @venue.id %>
        <div class='venue_form'>
          <h3>在<%= @venue.name%>上传照片：</h3>
          <%= form.label :title,'选择文件：'%> <%= form.file_field :photo,:style => "background:none;border:none;font-size:13px" %>
          <%= form.text_area :detail,:placeholder => '关于这个照片有什么需要说明的么？'%>
        </div>
        <p style="text-align:right">
          <%= form.submit '确 定',:class => "gary_button"%>
        </p>
      <% end %>
      
      <%= form_for @topic do |form| %>
          <div class='venue_form'>
          <h3>在<%= @venue.name%>提交故事：</h3>
            <%= raw error_explanation_for(@topic) if @topic.errors.present?%>  
            <%= form.label :title,'标题：'%> <%= form.text_field :title,:size => 20%>
            <br/>
            <%= form.text_area :content,:style => "height:96px",:placeholder => '故事的正文，不限字数'%>
            <%= form.hidden_field :venue_id ,:value => @venue.id %>
          </div>
          <p style="text-align:right">
          <%= form.submit '确 定',:class => "gary_button"%>
          </p>
      <% end %>
      <%= form_for @calling do |form| %>
        <div class='venue_form'>
          <h3>在<%= @venue.name%>召集行动：</h3>
          <%= raw error_explanation_for(@calling) if @calling.errors.present?%>
          <%= form.hidden_field :action_id,:value => 1%>
          <%= form.hidden_field :venue_id,:value => @venue.id %>
          <%= form.label 'title','行动标题：'%> <%= form.text_field :title, :size => 20, :placeholder => "" %><br/>
          <%= form.label 'total_people','需要人数：'%> <%= form.text_field :total_people, :size => 3, :placeholder => "" %>　
          <%= form.label 'total_people','行动时间：'%><%= form.text_field :do_at, :size => 8,:class => 'with_calendar',:placeholder => ""%><br/>
          <%= form.label 'address','集合地址：'%> <%= form.text_field :address, :size => 24, :placeholder => '',:style => "text-align:left" %><br/>
          <%= form.label 'contact','联系方式：'%> <%= form.text_field :contact, :size => 24, :placeholder => '',:style => "text-align:left" %><br/>
          <%= form.label 'detail','详细信息：'%>(字数要求：50-1000字)　目前字数：<span id="character_count"></span>
          <%= form.text_area :detail,:placeholder => '请说明你发起召集的原因、响应你的召集需要做什么。'%>
        </div>
        <p style="text-align:right">
          <%= form.submit '确 定',:class => "gary_button"%>
        </p>
      <% end %>

      <ul>
        <li><%= link_to raw("#{image_tag('/images/icon/saying.gif',:class => 'icon')} 报到"),'#new_saying'%></li>
        <li><%= link_to raw("#{image_tag('/images/icon/photo.gif',:class => 'icon')} 照片"),'#new_photo'%></li>
        <li><%= link_to raw("#{image_tag('/images/icon/topic.png',:class => 'icon')} 故事"),'#new_topic'%></li>
        <li><%= link_to raw("#{image_tag('/images/icon/calling.png',:class => 'icon')} 召集"),'#new_calling'%></li>
      </ul>
    </div>
  </div>
</div>

<div class="box">
  <h4>这里的新鲜事..</h4>
  <%= render :partial => '/public/event', :collection => @timeline %>
</div>  

<% if [@venue.follows_count,@venue.sayings_count,@venue.records_count,@venue.photos_count].sum.zero? %>
<div id="freshman" style="display:none">
  <div>
    <h2>欢迎拓荒者到来！</h2>
    <p>Hi，你是第一个来到这里的人。</p>
    <p>你很熟悉<%= @venue.name%>吧？或者在这里留下了珍贵的回忆。</p>
    <p>去用"报到"功能去吼一下吧，向后来者打个招呼。</p>
    <p style="padding:4px 10px;">
    </p>
    <br/>
    <p style="text-align:right">
      <%= link_to '知道了', "#",:class => 'button',:onclick => "javascript:$('#floatBox #close_dialog').click();return false"%>
    </p>
  </div>
</div>
<script type="text/javascript">
  dialog('欢迎',("id:freshman"),"570px","auto","text")
</script>
<% end %>

<% content_for :sidebar do %>
  <div class="box">
    <h4>关于<%= @venue.name%>：</h4>
    <pre style="font-size:13px"><%= @venue.intro%></pre>
    <span>
      <%= "地址： #{@venue.address}" unless @venue.blank?%><br/>
      <%= "联系方式： #{@venue.contact}" unless @venue.contact.blank?%>
    </span>
    <br/>
    <span>
    <%= link_to "#{@venue.cover_file_name ? '更新' : '上传'}主题图",cover_venue_path(@venue),:class => "open_dialog",:title => "#{@venue.cover_file_name ? '更新' : '上传'}主题图" if logged_in? && @venue.creator == current_user%>
    <%= link_to '更新信息',edit_venue_path(@venue),:id => 'update_info' if logged_in? && @venue.creator == current_user %>
    </span>
  </div>
  
  <div class="box">
    <span style="float:right"><%= link_to "查看大图",position_venue_path(@venue),:class => 'open_dialog',:title => '地点地图'%></h4></span>
    <h4>地图：</h4>
    <div id="sidebar_map_canvas" style="width:248px;height:160px;"></div>
  </div>
  
  <div class="box">
    <span style="float:right"><%= link_to "查看全部",followers_venue_path(@venue)%></h4></span>
    <h4><%= "#{@venue.follows.size}人关注这里："%></h4>
    <%= render :partial => "/users/user",:collection => @followers[0..7] %>
  </div>

<% end %>


<% content_for :extension do %>
  <script type="text/javascript">
      function initialize() {
      var latlng = new google.maps.LatLng(<%= "#{@venue.latitude || 35.0},#{@venue.longitude || 105.0}"%>)
      var myOptions = {
        zoom: 14 ,
        center: latlng,
        disableDefaultUI: true,
        navigationControl: true,
        mapTypeControl: true,
        mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
        scaleControl: false,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      small_map = new google.maps.Map(document.getElementById("sidebar_map_canvas"), myOptions);
      
      markers = new Array();
      markers['position'] = new Array();
      markers['position'][0] = new google.maps.Marker({
        map: small_map,
        position: small_map.getCenter(),
        title: '<%= @venue.name %>'
      });    
      infowindow = new google.maps.InfoWindow;     
    }; //initialize_end
    
    $(document).ready(function(){
      $("#formContaier form:first").show();
      $("#formContaier ul li a:first").addClass("active");
      $("#formContaier ul li a").click(function(){ 
        var activeTab = $(this).attr("href"); 
        $("#formContaier ul li a").removeClass("active"); 
        $(this).addClass("active");
        $("#formContaier form").hide();
        $(activeTab).show();
        return false;
      });
      
      $('.new_comment').submit(function(){
        var size = $(this).find('input[type=text]').val().length
        if ( size >= 140){
          alert('回复不能超过140字,你写了' + size + '个');
          return false
          }
        })      
      $('#new_saying').submit(function(){
        var size = $(this).find('textarea').val().length
        if ( size >= 140){
          alert('报到不能超过140字,你写了' + size + '个');
          return false
          }          
        });
      DateTimeShortcuts.init()
      function updateCount() {
      document.getElementById("character_count").innerHTML = document.getElementById("calling_detail").value.length;
      setTimeout(updateCount, 400);
       }
      updateCount();
      initialize()
      setTimeout(function(){$.post('<%= watching_venue_path(@venue)%>')},5000)
      
    });  
  </script>
<% end %>